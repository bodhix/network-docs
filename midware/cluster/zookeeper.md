## ZooKeeper

ZooKeeper （ZK）是一个高性能的分布式应用协调服务，管理分布式应用的配置、域名等，同时提供分布式同步和组服务等

### 概述

#### 设计目标

1. 简单：数据模型类似文件系统的树状组织结构，在内存中存放
2. 多副本：多副本集群，高可用，可扩展
3. 有序：通过版本号记录操作顺序，顺序一致性
4.  高性能：多读少写的情况下（10:1）性能很好，在 3 ~ 13 个节点组成的集群中，有几w ~ 十几w QPS

#### 保证

1. 顺序一致性
2. 原子性
3. 单一视图
4. 可靠

#### 实现

- 使用 ZAB（ZooKeeper 原子广播协议）
- 使用内存保存整个配置树数据
- 更新操作会先记录日志到磁盘，然后才写到内存配置树中
- 集群中每个 zk 都可以提供服务
- 更新操作会被转发到 leader 处理

### 系统模型

#### 数据模型

树状、层次命名空间

节点类型（ZNode）

- 永久节点：创建之后一直存在直到显式删除
- 临时节点：创建之后，会话（session）断开就自动删除。不能有孩子节点
- 有序节点：创建之后节点名称后面加序号后缀（可以是永久、也可以是临时）
- 容器节点：可能会被实现为，孩子节点删除之后，该节点自动删除（3.6.0 新增）
- TTL 节点：可能会被实现为，永久节点长时间没有更新，该节点自动删除（3.6.0 新增，需要手动启动，默认是不启用的）

#### watcher

监控变化。进行监控之后，当 ZNode 发生变化的时候监控者可以收到变化通知。

备注：貌似不能单独使用，必须使用上述 READ 类型的 API，在调用 API 的时候指定 watcher 才能使用该功能。

- 一次性：注册完成之后，事件触发，client 收到通知。如果再触发事件，那么就不会收到通知了。
- 异步：异步发送给 client
- 监控模型：data 事件以及 child 事件
- 永久、嵌套监控：（3.6.0 新增）

#### ACL

每个 ZNode 有权限控制。具有多个权限模型：scheme: id: permission

配置了权限之后，以后的每次操作，需要带上权限信息才允许操作。

内部权限检查分类：CREATE、READ、WRITE、DELETE、ADMIN

#### 会话

相当于是应用层自己维护的状态，由 session id 标识，会有心跳维护会话状态。正常的 TCP 断开连接不会导致会话断开，客户端会进行重连。心跳或者事务操作，都会触发会话激活。

#### 事务

特指会修改到 ZK 状态的操作，简单来说，一个更新（增、删、改）就是一个事务。会有事务 id（zxid），可以通过事务 id 了解 ZK 状态的先后修改顺序

#### 版本号

主要用于实现乐观锁

### 使用

#### API

关键 API： create、delete、exists、get data、set data、sync

#### 客户端

- ZkClient
- Curator

#### 典型应用场景

- 发布 / 订阅：watch
- 服务管理：实现类似 DNS 功能，或者更为抽象的 appid 到 ip:port 的映射关系。get / set data + watch
- 全局 ID：类似 UUID，但是更短，而且有意义。使用有序节点。
- 集群管理：
- 集群选主：临时节点 + watch
- 分布式锁：排他锁，使用临时节点 + watch；共享锁，使用临时有序节点 + watch

​    ......

通过这些可以发现，其实， ZK 提供的操作原语非常简单，只是将这些简单的原语组合起来，就可以实现很多上层服务。

### 参考资料

1. [ZooKeeper 官网]( https://zookeeper.apache.org/ )
2. 《从 Paxos 到 ZooKeeper 分布式一致性原理与实践》